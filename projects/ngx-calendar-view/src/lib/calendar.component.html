<div class="ncv-calendar-container ncv-bg-calendar-background ncv-border ncv-border-calendar-border ncv-rounded-lg ncv-shadow-sm">
  <!-- Desktop Header -->
  <div class="ncv-hidden ncv-md:block">
    @switch (currentViewType()) {
      @case ('day') {
        <div class="ncv-calendar-header-desktop ncv-p-4 ncv-border-b ncv-border-calendar-border">
          <div class="ncv-flex ncv-items-center ncv-justify-between">
            <div class="ncv-flex ncv-items-center ncv-space-x-4">
              <button
                (click)="navigatePrevious()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button
                (click)="navigateToday()"
                [class]="getTodayButtonClass()">
                Today
              </button>
              <button
                (click)="navigateNext()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <h2 class="ncv-text-lg ncv-font-semibold ncv-text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.DAY) }}
            </h2>
            @if (config().showViewTypeSelector !== false) {
              <div class="ncv-view-type-selector ncv-flex ncv-items-center ncv-space-x-2">
                @for (viewType of viewTypes; track viewType) {
                  <button
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('week') {
        <div class="ncv-calendar-header-desktop ncv-p-4 ncv-border-b ncv-border-calendar-border">
          <div class="ncv-flex ncv-items-center ncv-justify-between">
            <div class="ncv-flex ncv-items-center ncv-space-x-4">
              <button
                (click)="navigatePrevious()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button
                (click)="navigateToday()"
                [class]="getTodayButtonClass()">
                Today
              </button>
              <button
                (click)="navigateNext()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <h2 class="ncv-text-lg ncv-font-semibold ncv-text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.WEEK) }}
            </h2>
            @if (config().showViewTypeSelector !== false) {
              <div class="ncv-view-type-selector ncv-flex ncv-items-center ncv-space-x-2">
                @for (viewType of viewTypes; track viewType) {
                  <button
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('month') {
        <div class="ncv-calendar-header-desktop ncv-p-4 ncv-border-b ncv-border-calendar-border">
          <div class="ncv-flex ncv-items-center ncv-justify-between">
            <div class="ncv-flex ncv-items-center ncv-space-x-4">
              <button
                (click)="navigatePrevious()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button
                (click)="navigateToday()"
                [class]="getTodayButtonClass()">
                Today
              </button>
              <button
                (click)="navigateNext()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <h2 class="ncv-text-lg ncv-font-semibold ncv-text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.MONTH) }}
            </h2>
            @if (config().showViewTypeSelector !== false) {
              <div class="ncv-view-type-selector ncv-flex ncv-items-center ncv-space-x-2">
                @for (viewType of viewTypes; track viewType) {
                  <button
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Mobile Header -->
  <div class="ncv-block ncv-md:hidden">
    @switch (currentViewType()) {
      @case ('day') {
        <div class="ncv-calendar-header-mobile ncv-p-4 ncv-border-b ncv-border-calendar-border">
          <!-- Date label row -->
          <div class="ncv-text-center ncv-mb-3">
            <h2 class="ncv-text-lg ncv-font-semibold ncv-text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.DAY) }}
            </h2>
          </div>
          <!-- Navigation controls row -->
          <div class="ncv-flex ncv-items-center ncv-justify-between">
            <div class="ncv-flex ncv-items-center ncv-space-x-2">
              <button
                (click)="navigatePrevious()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button
                (click)="navigateToday()"
                [class]="getTodayButtonClass()">
                Today
              </button>
              <button
                (click)="navigateNext()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            @if (config().showViewTypeSelector !== false) {
              <div class="ncv-view-type-selector ncv-flex ncv-items-center ncv-space-x-1">
                @for (viewType of viewTypes; track viewType) {
                  <button
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('week') {
        <div class="ncv-calendar-header-mobile ncv-p-4 ncv-border-b ncv-border-calendar-border">
          <!-- Date label row -->
          <div class="ncv-text-center ncv-mb-3">
            <h2 class="ncv-text-lg ncv-font-semibold ncv-text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.WEEK) }}
            </h2>
          </div>
          <!-- Navigation controls row -->
          <div class="ncv-flex ncv-items-center ncv-justify-between">
            <div class="ncv-flex ncv-items-center ncv-space-x-2">
              <button
                (click)="navigatePrevious()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button
                (click)="navigateToday()"
                [class]="getTodayButtonClass()">
                Today
              </button>
              <button
                (click)="navigateNext()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            @if (config().showViewTypeSelector !== false) {
              <div class="ncv-view-type-selector ncv-flex ncv-items-center ncv-space-x-1">
                @for (viewType of viewTypes; track viewType) {
                  <button
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('month') {
        <div class="ncv-calendar-header-mobile ncv-p-4 ncv-border-b ncv-border-calendar-border">
          <!-- Date label row -->
          <div class="ncv-text-center ncv-mb-3">
            <h2 class="ncv-text-lg ncv-font-semibold ncv-text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.MONTH) }}
            </h2>
          </div>
          <!-- Navigation controls row -->
          <div class="ncv-flex ncv-items-center ncv-justify-between">
            <div class="ncv-flex ncv-items-center ncv-space-x-2">
              <button
                (click)="navigatePrevious()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button
                (click)="navigateToday()"
                [class]="getTodayButtonClass()">
                Today
              </button>
              <button
                (click)="navigateNext()"
                class="ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-rounded-md ncv-transition-colors">
                <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            @if (config().showViewTypeSelector !== false) {
              <div class="ncv-view-type-selector ncv-flex ncv-items-center ncv-space-x-1">
                @for (viewType of viewTypes; track viewType) {
                  <button
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Calendar Views -->
  <div class="ncv-calendar-content">
    @switch (currentViewType()) {
      @case ('day') {
        <div class="ncv-calendar-day-view ncv-p-4">
          <div class="ncv-grid ncv-grid-cols-1 ncv-gap-4">
            <!-- All-day events section -->
            @if (getAllDayEvents(currentDate()).length > 0) {
              <div class="ncv-all-day-events-section">
                <div class="ncv-all-day-header ncv-bg-calendar-surface ncv-p-2 ncv-rounded-md ncv-mb-2">
                  <div class="ncv-text-sm ncv-font-medium ncv-text-calendar-text-secondary">All Day</div>
                </div>
                <div
                  class="ncv-all-day-events-container"
                  [class.ncv-drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && !dragState().dropTarget?.time"
                  [attr.data-date]="currentDate().toISODate()">
                  @for (event of getAllDayEvents(currentDate()); track event.id) {

                    <div
                      class="ncv-all-day-event-card ncv-p-2 ncv-rounded ncv-text-xs ncv-cursor-pointer ncv-shadow-sm ncv-border-l-2 ncv-mb-1"
                      [style.background-color]="getEventProjectColor(event)"
                      [style.border-left-color]="getEventProjectColor(event)"
                      [class.ncv-dragging]="dragState().isDragging && dragState().draggedEvent?.id === event.id"
                      [class.ncv-drag-over]="dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && !dragState().dropTarget?.time"
                      [attr.data-event-id]="event.id"
                      (mouseenter)="showPopover(event, $event)"
                      (mouseleave)="hidePopover()"
                      (click)="onEventClick(event); $event.stopPropagation()"
                      (keydown)="onEventClick(event); $event.stopPropagation()"
                      tabindex="0">

                      <div class="ncv-font-medium ncv-text-gray-800">{{ event.title }}</div>
                      @if (event.description) {
                        <div class="ncv-text-gray-600 ncv-text-xs ncv-mt-1">{{ event.description }}</div>
                      }
                    </div>
                  }
                </div>
              </div>
            }

            <div class="ncv-time-slot-header ncv-bg-calendar-surface ncv-p-2 ncv-rounded-md">
              <div class="ncv-text-sm ncv-font-medium ncv-text-calendar-text-secondary ncv-p-2">Time</div>
            </div>
            <div class="ncv-time-slots">
              @for (slot of timeSlots(); track slot.time.toMillis()) {
                <div
                  class="ncv-time-slot ncv-min-h-slot ncv-border-b ncv-border-calendar-border ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-cursor-pointer ncv-relative"
                  [class.ncv-drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                  [class.ncv-drag-hover-active]="dragState().isDragging && isHoveringTimeSlot(slot.time, currentDate())"
                  [attr.data-time]="slot.time.toISO()"
                  [attr.data-date]="currentDate().toISODate()"
                  (click)="onTimeSlotClick(slot.time)"
                  (keydown)="onTimeSlotClick(slot.time)"
                  tabindex="0">
                  <div class="ncv-text-xs ncv-text-calendar-text-secondary ncv-absolute ncv-left-2 ncv-top-2 ncv-z-10">{{ slot.label }}</div>
                  <!-- Events for this time slot -->
                  @for (stackedEvent of getStackedEventsForSlot(getEventsForTimeSlot(slot.time)); track stackedEvent.event.id) {
                    @let position = getEventPositionInSlot(stackedEvent.event, slot.time);
                    @let slotDuration = config().timeSlotDuration || 30;

                      <div
                        class="ncv-event-card ncv-rounded ncv-text-xs ncv-cursor-pointer ncv-shadow-sm ncv-border-l-2"
                        [style.background-color]="getEventProjectColor(stackedEvent.event)"
                        [style.border-left-color]="getEventProjectColor(stackedEvent.event)"
                        [style.top.rem]="position.top"
                        [style.height.rem]="position.height"
                        [style.left.rem]="stackedEvent.left"
                        [style.width.%]="stackedEvent.width"
                        [class.ncv-dragging]="dragState().isDragging && dragState().draggedEvent?.id === stackedEvent.event.id"
                        [class.ncv-drag-over]="dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                        [attr.data-event-id]="stackedEvent.event.id"
                        (mouseenter)="showPopover(stackedEvent.event, $event)"
                        (mouseleave)="hidePopover()"
                        (click)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        (keydown)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        tabindex="0">

                      <div class="ncv-font-medium ncv-text-gray-800 ncv-truncate ncv-p-1">{{ stackedEvent.event.title }}</div>
                      @if (stackedEvent.event.description && shouldShowDescription(stackedEvent.event, slotDuration)) {
                        <div class="ncv-text-gray-600 ncv-truncate ncv-px-1 ncv-pb-1">{{ stackedEvent.event.description }}</div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }
      @case ('week') {
        <div class="ncv-calendar-week-view ncv-p-4">
          <div class="ncv-grid ncv-grid-cols-8 ncv-gap-1">
            <!-- Time column -->
            <div class="ncv-time-column">
              <div class="ncv-time-slot-header ncv-bg-calendar-surface ncv-p-2 ncv-rounded-md ncv-mb-1">
                <div class="ncv-text-sm ncv-font-medium ncv-text-calendar-text-secondary ncv-p-2">Time</div>
              </div>
              <!-- All-day events row -->
              @if (hasAllDayEventsInWeek()) {
                <div
                  class="ncv-all-day-row ncv-min-h-slot ncv-border-b ncv-border-calendar-border ncv-p-1"
                  [style.height]="getAllDayRowHeight()">
                  <div class="ncv-text-xs ncv-text-calendar-text-secondary">All Day</div>
                </div>
              }
              @for (slot of timeSlots(); track slot.time.toMillis()) {
                <div class="ncv-time-slot ncv-min-h-slot ncv-border-b ncv-border-calendar-border ncv-p-1">
                  <div class="ncv-text-xs ncv-text-calendar-text-secondary">{{ slot.label }}</div>
                </div>
              }
            </div>
            <!-- Day columns -->
            @for (day of weekDays(); track day.toISODate()) {
              <div class="ncv-day-column">
                <div class="ncv-day-header ncv-bg-calendar-surface ncv-p-2 ncv-rounded-md ncv-mb-1 ncv-text-center">
                  <div class="ncv-text-sm ncv-font-medium ncv-text-calendar-text">{{ day.toFormat('EEE') }}</div>
                  <div class="ncv-text-xs ncv-text-calendar-text-secondary">{{ day.toFormat('d') }}</div>
                </div>
                <!-- All-day events for this day -->
                @if (hasAllDayEventsInWeek()) {
                  <div
                    class="ncv-all-day-events-day ncv-border-b ncv-border-calendar-border ncv-p-1 ncv-hover:ncv-bg-calendar-surface ncv-cursor-pointer"
                    [style.height]="getAllDayRowHeight()"
                    [class.ncv-drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === day.toISODate() && !dragState().dropTarget?.time"
                    [attr.data-date]="day.toISODate()"
                    (click)="onDayClick(day)"
                    (keydown)="onDayClick(day)"
                    tabindex="0">
                    @if (getAllDayEvents(day).length > 0) {
                      @for (event of getAllDayEvents(day); track event.id) {

                        <div
                          class="ncv-all-day-event-card ncv-p-1 ncv-rounded ncv-text-xs ncv-cursor-pointer ncv-shadow-sm ncv-border-l-2 ncv-mb-1"
                          [style.background-color]="getEventProjectColor(event)"
                          [style.border-left-color]="getEventProjectColor(event)"
                          [class.ncv-dragging]="dragState().isDragging && dragState().draggedEvent?.id === event.id"
                          [class.ncv-drag-over]="dragState().dropTarget?.date?.toISODate() === day.toISODate() && !dragState().dropTarget?.time"
                          [attr.data-event-id]="event.id"
                          (mouseenter)="showPopover(event, $event)"
                          (mouseleave)="hidePopover()"
                          (click)="onEventClick(event); $event.stopPropagation()"
                          (keydown)="onEventClick(event); $event.stopPropagation()"
                          tabindex="0">

                          <div class="ncv-font-medium ncv-text-gray-800 ncv-truncate">{{ event.title }}</div>
                        </div>
                      }
                    } @else {
                      <!-- Empty all-day row for days without all-day events -->
                      <div class="ncv-text-xs ncv-text-calendar-text-secondary ncv-opacity-50 ncv-py-1">
                      </div>
                    }
                  </div>
                }
                @for (slot of timeSlots(); track slot.time.toMillis()) {
                  <div
                    class="ncv-time-slot ncv-min-h-slot ncv-border-b ncv-border-calendar-border ncv-hover:ncv-bg-calendar-surface ncv-cursor-pointer ncv-relative"
                    [class.ncv-drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === day.toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                    [class.ncv-drag-hover-active]="dragState().isDragging && isHoveringTimeSlot(slot.time, day)"
                    [attr.data-time]="slot.time.toISO()"
                    [attr.data-date]="day.toISODate()"
                    (click)="onTimeSlotClick(slot.time, day)"
                    (keydown)="onTimeSlotClick(slot.time, day)"
                    tabindex="0">
                    <!-- Events for this time slot and day -->
                    @for (stackedEvent of getStackedEventsForSlot(getEventsForTimeSlot(slot.time, day)); track stackedEvent.event.id) {
                      @let position = getEventPositionInSlot(stackedEvent.event, slot.time);
                      @let slotDuration = config().timeSlotDuration || 30;

                      <div
                        class="ncv-event-card ncv-rounded ncv-text-xs ncv-cursor-pointer ncv-shadow-sm ncv-border-l-2"
                        [style.background-color]="getEventProjectColor(stackedEvent.event)"
                        [style.border-left-color]="getEventProjectColor(stackedEvent.event)"
                        [style.top.rem]="position.top"
                        [style.height.rem]="position.height"
                        [style.left.%]="stackedEvent.left"
                        [style.width.%]="stackedEvent.width"
                        [class.ncv-dragging]="dragState().isDragging && dragState().draggedEvent?.id === stackedEvent.event.id"
                        [class.ncv-drag-over]="dragState().dropTarget?.date?.toISODate() === day.toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                        [attr.data-event-id]="stackedEvent.event.id"
                        (mouseenter)="showPopover(stackedEvent.event, $event)"
                        (mouseleave)="hidePopover()"
                        (click)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        (keydown)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        tabindex="0">

                        <div class="ncv-font-medium ncv-text-gray-800 ncv-truncate ncv-p-1">{{ stackedEvent.event.title }}</div>
                        @if (stackedEvent.event.description && shouldShowDescription(stackedEvent.event, slotDuration)) {
                          <div class="ncv-text-gray-600 ncv-truncate ncv-px-1 ncv-pb-1">{{ stackedEvent.event.description }}</div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('month') {
        <div class="ncv-calendar-month-view ncv-p-4">
          <div class="ncv-grid ncv-grid-cols-7 ncv-gap-1">
            <!-- Day headers -->
            @for (dayName of dayNames; track dayName) {
              <div class="ncv-day-header ncv-bg-calendar-surface ncv-p-2 ncv-rounded-md ncv-text-center">
                <div class="ncv-text-sm ncv-font-medium ncv-text-calendar-text-secondary">{{ dayName }}</div>
              </div>
            }
            <!-- Month days -->
            @for (day of monthDays(); track day.toISODate()) {
              <div
                class="ncv-month-day ncv-min-h-24 ncv-border ncv-border-calendar-border ncv-p-2 ncv-hover:ncv-bg-calendar-surface ncv-cursor-pointer ncv-relative"
                [class.ncv-bg-calendar-surface]="!isCurrentMonth(day, currentDate())"
                [class.ncv-font-semibold]="isToday(day)"
                [class.ncv-drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === day.toISODate()"
                [attr.data-date]="day.toISODate()"
                (click)="onDayClick(day)"
                (keydown)="onDayClick(day)"
                tabindex="0">
                <div class="ncv-text-sm ncv-text-calendar-text">{{ day.toFormat('d') }}</div>
                <!-- Events for this day -->
                @if (getEventsForDay(day).length > 0) {
                  @let dayEvents = getEventsForDay(day);
                  @let visibleEvents = getVisibleEvents(dayEvents, 3);
                  <div class="ncv-mt-1 ncv-space-y-0.5">
                    @for (event of visibleEvents.visible; track event.id) {

                      <div
                        class="ncv-event-card ncv-p-1 ncv-rounded ncv-text-xs ncv-cursor-pointer ncv-shadow-sm ncv-border-l-2 ncv-truncate ncv-block ncv-w-full"
                        [style.background-color]="getEventProjectColor(event)"
                        [style.border-left-color]="getEventProjectColor(event)"
                        [class.ncv-dragging]="dragState().isDragging && dragState().draggedEvent?.id === event.id"
                        [class.ncv-drag-over]="dragState().dropTarget?.date?.toISODate() === day.toISODate()"
                        [attr.data-event-id]="event.id"
                        (click)="onEventClick(event); $event.stopPropagation()"
                        (keydown)="onEventClick(event); $event.stopPropagation()"
                        tabindex="0">

                        <div class="ncv-font-medium ncv-text-gray-800 ncv-truncate">{{ event.title }}</div>
                        @if (event.time) {
                          <div class="ncv-text-gray-600 ncv-text-xs">{{ event.time.toFormat('HH:mm') }}</div>
                        }
                      </div>
                    }
                    @if (visibleEvents.hidden > 0) {
                      <div
                        class="ncv-text-xs ncv-text-blue-600 ncv-hover:ncv-text-blue-800 ncv-cursor-pointer ncv-font-medium ncv-mt-1"
                        (click)="$event.stopPropagation()"
                        (keydown)="$event.stopPropagation()"
                        tabindex="0">
                        +{{ visibleEvents.hidden }} more
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Drag Preview -->
  @if (dragState().isDragging && dragState().draggedEvent) {
    <div
      class="ncv-drag-preview ncv-fixed ncv-pointer-events-none ncv-z-50"
      [style.left.px]="dragState().dragPosition?.x || 0"
      [style.top.px]="dragState().dragPosition?.y || 0">
      <div
        class="ncv-event-card ncv-rounded ncv-text-xs ncv-shadow-lg ncv-border-l-2 ncv-p-2"
        [style.background-color]="getEventProjectColor(dragState().draggedEvent!)"
        [style.border-left-color]="getEventProjectColor(dragState().draggedEvent!)">
        <div class="ncv-font-medium ncv-text-gray-800 ncv-truncate">{{ dragState().draggedEvent!.title }}</div>
        @if (dragState().draggedEvent!.description) {
          <div class="ncv-text-gray-600 ncv-truncate ncv-text-xs ncv-mt-1">{{ dragState().draggedEvent!.description }}</div>
        }
      </div>
    </div>
  }

  <!-- Event Details Popover (Desktop) -->
  @if (shouldShowPopover && popoverEventData) {
    <div
      class="ncv-event-popover ncv-fixed ncv-z-50 ncv-bg-white ncv-border ncv-border-gray-200 ncv-rounded-lg ncv-shadow-lg ncv-p-4 ncv-max-w-sm"
      [style.left.px]="popoverPositionData?.x || 0"
      [style.top.px]="(popoverPositionData?.y || 0) - 10">
      <div class="ncv-flex ncv-items-start ncv-justify-between ncv-mb-2">
        <h3 class="ncv-font-semibold ncv-text-gray-900 ncv-text-sm">{{ popoverEventData.title }}</h3>
        <button
          (click)="hidePopover()"
          class="ncv-text-gray-400 ncv-hover:ncv-text-gray-600 ncv-ml-2">
          <svg class="ncv-w-4 ncv-h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>

      @if (popoverEventData.description) {
        <p class="ncv-text-gray-600 ncv-text-sm ncv-mb-3">{{ popoverEventData.description }}</p>
      }

      <div class="ncv-space-y-1 ncv-text-xs ncv-text-gray-500">
        @if (popoverEventData.time) {
          <div class="ncv-flex ncv-items-center">
            <svg class="ncv-w-3 ncv-h-3 ncv-mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ popoverEventData.time.toFormat('HH:mm') }}
            @if (popoverEventData.duration) {
              - {{ popoverEventData.time.plus({ minutes: popoverEventData.duration }).toFormat('HH:mm') }}
            }
          </div>
        }

        <div class="ncv-flex ncv-items-center">
          <svg class="ncv-w-3 ncv-h-3 ncv-mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          {{ (popoverEventData.time || popoverEventData.date).toFormat('EEEE, MMMM d, yyyy') }}
        </div>

        @if (popoverEventData.project) {
          <div class="ncv-flex ncv-items-center">
            <div
              class="ncv-w-3 ncv-h-3 ncv-rounded-full ncv-mr-1"
              [style.background-color]="getEventProjectColor(popoverEventData)">
            </div>
            {{ popoverEventData.project }}
          </div>
        }

        @if (popoverEventData.duration) {
          <div class="ncv-flex ncv-items-center">
            <svg class="ncv-w-3 ncv-h-3 ncv-mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ popoverEventData.duration }} minutes
          </div>
        }
      </div>
    </div>
  }

  <!-- Mobile Event Details Overlay -->
  @if (shouldShowMobileOverlay && mobileOverlayEventData) {
    <div
      class="ncv-mobile-event-overlay ncv-fixed ncv-inset-0 ncv-z-50 ncv-bg-black ncv-bg-opacity-50 ncv-flex ncv-items-center ncv-justify-center ncv-p-4"
      (click)="hideMobileOverlay()"
      (keydown)="hideMobileOverlay()"
      tabindex="0"
      role="dialog"
      aria-modal="true"
      aria-labelledby="mobile-event-title">
      <div
        class="ncv-mobile-event-details ncv-bg-white ncv-rounded-lg ncv-shadow-xl ncv-max-w-sm ncv-w-full ncv-mx-4"
        (click)="$event.stopPropagation()"
        (keydown)="$event.stopPropagation()"
        tabindex="0">
        <div class="ncv-p-6">
          <div class="ncv-flex ncv-items-start ncv-justify-between ncv-mb-4">
            <h3 id="mobile-event-title" class="ncv-font-semibold ncv-text-gray-900 ncv-text-lg">{{ mobileOverlayEventData.title }}</h3>
            <button
              (click)="hideMobileOverlay()"
              class="ncv-text-gray-400 ncv-hover:ncv-text-gray-600 ncv-ml-2 ncv-p-1">
              <svg class="ncv-w-5 ncv-h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>

          @if (mobileOverlayEventData.description) {
            <p class="ncv-text-gray-600 ncv-text-sm ncv-mb-4">{{ mobileOverlayEventData.description }}</p>
          }

          <div class="ncv-space-y-3 ncv-text-sm ncv-text-gray-500 ncv-mb-6">
            @if (mobileOverlayEventData.time) {
              <div class="ncv-flex ncv-items-center">
                <svg class="ncv-w-4 ncv-h-4 ncv-mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="ncv-font-medium">{{ mobileOverlayEventData.time.toFormat('HH:mm') }}</span>
                @if (mobileOverlayEventData.duration) {
                  <span class="ncv-ml-1">- {{ mobileOverlayEventData.time.plus({ minutes: mobileOverlayEventData.duration }).toFormat('HH:mm') }}</span>
                }
              </div>
            }

            <div class="ncv-flex ncv-items-center">
              <svg class="ncv-w-4 ncv-h-4 ncv-mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
              </svg>
              {{ (mobileOverlayEventData.time || mobileOverlayEventData.date).toFormat('EEEE, MMMM d, yyyy') }}
            </div>

            @if (mobileOverlayEventData.project) {
              <div class="ncv-flex ncv-items-center">
                <div
                  class="ncv-w-4 ncv-h-4 ncv-rounded-full ncv-mr-2"
                  [style.background-color]="getEventProjectColor(mobileOverlayEventData)">
                </div>
                {{ mobileOverlayEventData.project }}
              </div>
            }

            @if (mobileOverlayEventData.duration) {
              <div class="ncv-flex ncv-items-center">
                <svg class="ncv-w-4 ncv-h-4 ncv-mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                {{ mobileOverlayEventData.duration }} minutes
              </div>
            }
          </div>

          <div class="ncv-flex ncv-gap-3">
            <button
              (click)="onMobileOverlayEditClick(mobileOverlayEventData)"
              class="ncv-flex-1 ncv-bg-blue-600 ncv-text-white ncv-px-4 ncv-py-2 ncv-rounded-md ncv-font-medium ncv-hover:ncv-bg-blue-700 ncv-transition-colors">
              Edit
            </button>
            <button
              (click)="hideMobileOverlay()"
              class="ncv-flex-1 ncv-bg-gray-200 ncv-text-gray-800 ncv-px-4 ncv-py-2 ncv-rounded-md ncv-font-medium ncv-hover:ncv-bg-gray-300 ncv-transition-colors">
              Close
            </button>
          </div>
        </div>
      </div>
    </div>
  }
</div>
