<div class="calendar-container bg-calendar-background border border-calendar-border rounded-lg shadow-sm">
  <!-- Desktop Header -->
  <div class="hidden md:block">
    @switch (currentViewType()) {
      @case ('day') {
        <div class="calendar-header-desktop p-4 border-b border-calendar-border">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <button 
                (click)="navigatePrevious()"
                class="p-2 hover:bg-calendar-surface rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button 
                (click)="navigateToday()"
                class="px-3 py-1 text-sm bg-calendar-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                Today
              </button>
              <button 
                (click)="navigateNext()"
                class="p-2 hover:bg-calendar-surface rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <h2 class="text-lg font-semibold text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.DAY) }}
            </h2>
            @if (config().showViewTypeSelector !== false) {
              <div class="flex items-center space-x-2">
                @for (viewType of viewTypes; track viewType) {
                  <button 
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('week') {
        <div class="calendar-header-desktop p-4 border-b border-calendar-border">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <button 
                (click)="navigatePrevious()"
                class="p-2 hover:bg-calendar-surface rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button 
                (click)="navigateToday()"
                class="px-3 py-1 text-sm bg-calendar-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                Today
              </button>
              <button 
                (click)="navigateNext()"
                class="p-2 hover:bg-calendar-surface rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <h2 class="text-lg font-semibold text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.WEEK) }}
            </h2>
            @if (config().showViewTypeSelector !== false) {
              <div class="flex items-center space-x-2">
                @for (viewType of viewTypes; track viewType) {
                  <button 
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('month') {
        <div class="calendar-header-desktop p-4 border-b border-calendar-border">
          <div class="flex items-center justify-between">
            <div class="flex items-center space-x-4">
              <button 
                (click)="navigatePrevious()"
                class="p-2 hover:bg-calendar-surface rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
                </svg>
              </button>
              <button 
                (click)="navigateToday()"
                class="px-3 py-1 text-sm bg-calendar-primary text-white rounded-md hover:bg-opacity-90 transition-colors">
                Today
              </button>
              <button 
                (click)="navigateNext()"
                class="p-2 hover:bg-calendar-surface rounded-md transition-colors">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>
            <h2 class="text-lg font-semibold text-calendar-text">
              {{ formatDateForDisplay(currentDate(), CalendarViewType.MONTH) }}
            </h2>
            @if (config().showViewTypeSelector !== false) {
              <div class="flex items-center space-x-2">
                @for (viewType of viewTypes; track viewType) {
                  <button 
                    (click)="setViewType(viewType)"
                    [class]="getViewTypeButtonClass(viewType)">
                    {{ viewType | titlecase }}
                  </button>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Mobile Header -->
  <div class="block md:hidden">
    <div class="calendar-header-mobile p-4 border-b border-calendar-border">
      <div class="flex items-center justify-between mb-3">
        <select 
          (change)="onMonthSelect($event)"
          class="px-3 py-2 border border-calendar-border rounded-md bg-calendar-background text-calendar-text">
          @for (month of monthOptions(); track month.value) {
            <option [value]="month.value">
              {{ month.label }}
            </option>
          }
        </select>
        @if (config().showViewTypeSelector !== false) {
          <div class="flex items-center space-x-2">
            @for (viewType of viewTypes; track viewType) {
              <button 
                (click)="setViewType(viewType)"
                [class]="getViewTypeButtonClass(viewType)">
                {{ viewType | titlecase }}
              </button>
            }
          </div>
        }
      </div>
      <h2 class="text-lg font-semibold text-calendar-text text-center">
        {{ formatDateForDisplay(currentDate(), currentViewType()) }}
      </h2>
    </div>
  </div>

  <!-- Calendar Views -->
  <div class="calendar-content">
    @switch (currentViewType()) {
      @case ('day') {
        <div class="calendar-day-view p-4">
          <div class="grid grid-cols-1 gap-4">
            <!-- All-day events section -->
            @if (getAllDayEvents(currentDate()).length > 0) {
              <div class="all-day-events-section">
                <div class="all-day-header bg-calendar-surface p-2 rounded-md mb-2">
                  <div class="text-sm font-medium text-calendar-text-secondary">All Day</div>
                </div>
                <div 
                  class="all-day-events-container"
                  [class.drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && !dragState().dropTarget?.time"
                  [attr.data-date]="currentDate().toISODate()">
                  @for (event of getAllDayEvents(currentDate()); track event.id) {
                    
                    <div 
                      class="all-day-event-card p-2 rounded text-xs cursor-pointer shadow-sm border-l-2 mb-1"
                      [style.background-color]="getEventProjectColor(event)"
                      [style.border-left-color]="getEventProjectColor(event)"
                      [class.dragging]="dragState().isDragging && dragState().draggedEvent?.id === event.id"
                      [class.drag-over]="dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && !dragState().dropTarget?.time"
                      [attr.data-event-id]="event.id"
                      (mouseenter)="showPopover(event, $event)"
                      (mouseleave)="hidePopover()"
                      (click)="onEventClick(event); $event.stopPropagation()"
                      (keydown)="onEventClick(event); $event.stopPropagation()"
                      tabindex="0">
                      Cor: {{getEventProjectColor(event)}}
                      <div class="font-medium text-gray-800">{{ event.title }} Cor: {{getEventProjectColor(event)}}</div>
                      @if (event.description) {
                        <div class="text-gray-600 text-xs mt-1">{{ event.description }}</div>
                      }
                    </div>
                  }
                </div>
              </div>
            }
            
            <div class="time-slot-header bg-calendar-surface p-2 rounded-md">
              <div class="text-sm font-medium text-calendar-text-secondary p-2">Time</div>
            </div>
            <div class="time-slots">
              @for (slot of timeSlots(); track slot.time.toMillis()) {
                <div 
                  class="time-slot min-h-slot border-b border-calendar-border p-2 hover:bg-calendar-surface cursor-pointer relative"
                  [class.drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                  [attr.data-time]="slot.time.toISO()"
                  [attr.data-date]="currentDate().toISODate()"
                  (click)="onTimeSlotClick(slot.time)"
                  (keydown)="onTimeSlotClick(slot.time)"
                  tabindex="0">
                  <div class="text-xs text-calendar-text-secondary absolute left-2 top-2 z-10">{{ slot.label }}</div>
                  <!-- Events for this time slot -->
                  @for (stackedEvent of getStackedEventsForSlot(getEventsForTimeSlot(slot.time)); track stackedEvent.event.id) {
                    @let position = getEventPositionInSlot(stackedEvent.event, slot.time);
                    @let slotDuration = config().timeSlotDuration || 30;
                      
                      <div 
                        class="event-card rounded text-xs cursor-pointer shadow-sm border-l-2"
                        [style.background-color]="getEventProjectColor(stackedEvent.event)"
                        [style.border-left-color]="getEventProjectColor(stackedEvent.event)"
                        [style.top.rem]="position.top"
                        [style.height.rem]="position.height"
                        [style.left.rem]="stackedEvent.left"
                        [style.width.%]="stackedEvent.width"
                        [class.dragging]="dragState().isDragging && dragState().draggedEvent?.id === stackedEvent.event.id"
                        [class.drag-over]="dragState().dropTarget?.date?.toISODate() === currentDate().toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                        [attr.data-event-id]="stackedEvent.event.id"
                        (mouseenter)="showPopover(stackedEvent.event, $event)"
                        (mouseleave)="hidePopover()"
                        (click)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        (keydown)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        tabindex="0">
                        Cor: {{getEventProjectColor(stackedEvent.event)}}  
                      <div class="font-medium text-gray-800 truncate p-1">{{ stackedEvent.event.title }} Cor: {{getEventProjectColor(stackedEvent.event)}}</div>
                      @if (stackedEvent.event.description && shouldShowDescription(stackedEvent.event, slotDuration)) {
                        <div class="text-gray-600 truncate px-1 pb-1">{{ stackedEvent.event.description }}</div>
                      }
                    </div>
                  }
                </div>
              }
            </div>
          </div>
        </div>
      }
      @case ('week') {
        <div class="calendar-week-view p-4">
          <div class="grid grid-cols-8 gap-1">
            <!-- Time column -->
            <div class="time-column">
              <div class="time-slot-header bg-calendar-surface p-2 rounded-md mb-1">
                <div class="text-sm font-medium text-calendar-text-secondary p-2">Time</div>
              </div>
              <!-- All-day events row -->
              @if (hasAllDayEventsInWeek()) {
                <div 
                  class="all-day-row min-h-slot border-b border-calendar-border p-1"
                  [style.height]="getAllDayRowHeight()">
                  <div class="text-xs text-calendar-text-secondary">All Day</div>
                </div>
              }
              @for (slot of timeSlots(); track slot.time.toMillis()) {
                <div class="time-slot min-h-slot border-b border-calendar-border p-1">
                  <div class="text-xs text-calendar-text-secondary">{{ slot.label }}</div>
                </div>
              }
            </div>
            <!-- Day columns -->
            @for (day of weekDays(); track day.toISODate()) {
              <div class="day-column">
                <div class="day-header bg-calendar-surface p-2 rounded-md mb-1 text-center">
                  <div class="text-sm font-medium text-calendar-text">{{ day.toFormat('EEE') }}</div>
                  <div class="text-xs text-calendar-text-secondary">{{ day.toFormat('d') }}</div>
                </div>
                <!-- All-day events for this day -->
                @if (hasAllDayEventsInWeek()) {
                  <div 
                    class="all-day-events-day border-b border-calendar-border p-1 hover:bg-calendar-surface cursor-pointer"
                    [style.height]="getAllDayRowHeight()"
                    [class.drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === day.toISODate() && !dragState().dropTarget?.time"
                    [attr.data-date]="day.toISODate()"
                    (click)="onDayClick(day)"
                    (keydown)="onDayClick(day)"
                    tabindex="0">
                    @if (getAllDayEvents(day).length > 0) {
                      @for (event of getAllDayEvents(day); track event.id) {
                        
                        <div 
                          class="all-day-event-card p-1 rounded text-xs cursor-pointer shadow-sm border-l-2 mb-1"
                          [style.background-color]="getEventProjectColor(event)"
                          [style.border-left-color]="getEventProjectColor(event)"
                          [class.dragging]="dragState().isDragging && dragState().draggedEvent?.id === event.id"
                          [class.drag-over]="dragState().dropTarget?.date?.toISODate() === day.toISODate() && !dragState().dropTarget?.time"
                          [attr.data-event-id]="event.id"
                          (mouseenter)="showPopover(event, $event)"
                          (mouseleave)="hidePopover()"
                          (click)="onEventClick(event); $event.stopPropagation()"
                          (keydown)="onEventClick(event); $event.stopPropagation()"
                          tabindex="0">
                          Cor: {{getEventProjectColor(event)}}
                          <div class="font-medium text-gray-800 truncate">{{ event.title }} Cor: {{getEventProjectColor(event)}}</div>
                        </div>
                      }
                    } @else {
                      <!-- Empty all-day row for days without all-day events -->
                      <div class="text-xs text-calendar-text-secondary opacity-50 py-1">
                      </div>
                    }
                  </div>
                }
                @for (slot of timeSlots(); track slot.time.toMillis()) {
                  <div 
                    class="time-slot min-h-slot border-b border-calendar-border hover:bg-calendar-surface cursor-pointer relative"
                    [class.drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === day.toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                    [attr.data-time]="slot.time.toISO()"
                    [attr.data-date]="day.toISODate()"
                    (click)="onTimeSlotClick(slot.time, day)"
                    (keydown)="onTimeSlotClick(slot.time, day)"
                    tabindex="0">
                    <!-- Events for this time slot and day -->
                    @for (stackedEvent of getStackedEventsForSlot(getEventsForTimeSlot(slot.time, day)); track stackedEvent.event.id) {
                      @let position = getEventPositionInSlot(stackedEvent.event, slot.time);
                      @let slotDuration = config().timeSlotDuration || 30;
                      
                      <div 
                        class="event-card rounded text-xs cursor-pointer shadow-sm border-l-2"
                        [style.background-color]="getEventProjectColor(stackedEvent.event)"
                        [style.border-left-color]="getEventProjectColor(stackedEvent.event)"
                        [style.top.rem]="position.top"
                        [style.height.rem]="position.height"
                        [style.left.%]="stackedEvent.left"
                        [style.width.%]="stackedEvent.width"
                        [class.dragging]="dragState().isDragging && dragState().draggedEvent?.id === stackedEvent.event.id"
                        [class.drag-over]="dragState().dropTarget?.date?.toISODate() === day.toISODate() && dragState().dropTarget?.time?.toISODate() === slot.time.toISODate()"
                        [attr.data-event-id]="stackedEvent.event.id"
                        (mouseenter)="showPopover(stackedEvent.event, $event)"
                        (mouseleave)="hidePopover()"
                        (click)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        (keydown)="onEventClick(stackedEvent.event); $event.stopPropagation()"
                        tabindex="0">
                        Cor: {{getEventProjectColor(stackedEvent.event)}}
                        <div class="font-medium text-gray-800 truncate p-1">{{ stackedEvent.event.title }} Cor: {{getEventProjectColor(stackedEvent.event)}}</div>
                        @if (stackedEvent.event.description && shouldShowDescription(stackedEvent.event, slotDuration)) {
                          <div class="text-gray-600 truncate px-1 pb-1">{{ stackedEvent.event.description }}</div>
                        }
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
      @case ('month') {
        <div class="calendar-month-view p-4">
          <div class="grid grid-cols-7 gap-1">
            <!-- Day headers -->
            @for (dayName of dayNames; track dayName) {
              <div class="day-header bg-calendar-surface p-2 rounded-md text-center">
                <div class="text-sm font-medium text-calendar-text-secondary">{{ dayName }}</div>
              </div>
            }
            <!-- Month days -->
            @for (day of monthDays(); track day.toISODate()) {
              <div 
                class="month-day min-h-24 border border-calendar-border p-2 hover:bg-calendar-surface cursor-pointer relative"
                [class.bg-calendar-surface]="!isCurrentMonth(day, currentDate())"
                [class.font-semibold]="isToday(day)"
                [class.drop-zone-active]="dragState().isDragging && dragState().dropTarget?.date?.toISODate() === day.toISODate()"
                [attr.data-date]="day.toISODate()"
                (click)="onDayClick(day)"
                (keydown)="onDayClick(day)"
                tabindex="0">
                <div class="text-sm text-calendar-text">{{ day.toFormat('d') }}</div>
                <!-- Events for this day -->
                @if (getEventsForDay(day).length > 0) {
                  @let dayEvents = getEventsForDay(day);
                  @let visibleEvents = getVisibleEvents(dayEvents, 3);
                  <div class="mt-1 space-y-0.5">
                    @for (event of visibleEvents.visible; track event.id) {
                      
                      <div 
                        class="event-card p-1 rounded text-xs cursor-pointer shadow-sm border-l-2 truncate block w-full"
                        [style.background-color]="getEventProjectColor(event)"
                        [style.border-left-color]="getEventProjectColor(event)"
                        [class.dragging]="dragState().isDragging && dragState().draggedEvent?.id === event.id"
                        [class.drag-over]="dragState().dropTarget?.date?.toISODate() === day.toISODate()"
                        [attr.data-event-id]="event.id"
                        (click)="showPopover(event, $event); onEventClick(event); $event.stopPropagation()"
                        (keydown)="showPopover(event, $event); onEventClick(event); $event.stopPropagation()"
                        tabindex="0">
                        Cor: {{getEventProjectColor(event)}}
                        <div class="font-medium text-gray-800 truncate">{{ event.title }} Cor: {{getEventProjectColor(event)}}</div>
                        @if (event.time) {
                          <div class="text-gray-600 text-xs">{{ event.time.toFormat('HH:mm') }}</div>
                        }
                      </div>
                    }
                    @if (visibleEvents.hidden > 0) {
                      <div 
                        class="text-xs text-blue-600 hover:text-blue-800 cursor-pointer font-medium mt-1"
                        (click)="$event.stopPropagation()"
                        (keydown)="$event.stopPropagation()"
                        tabindex="0">
                        +{{ visibleEvents.hidden }} more
                      </div>
                    }
                  </div>
                }
              </div>
            }
          </div>
        </div>
      }
    }
  </div>

  <!-- Event Details Popover -->
  @if (shouldShowPopover && popoverEventData) {
    <div 
      class="event-popover fixed z-50 bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm"
      [style.left.px]="popoverPositionData?.x || 0"
      [style.top.px]="(popoverPositionData?.y || 0) - 10">
      <div class="flex items-start justify-between mb-2">
        <h3 class="font-semibold text-gray-900 text-sm">{{ popoverEventData.title }}</h3>
        <button 
          (click)="hidePopover()"
          class="text-gray-400 hover:text-gray-600 ml-2">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      </div>
      
      @if (popoverEventData.description) {
        <p class="text-gray-600 text-sm mb-3">{{ popoverEventData.description }}</p>
      }
      
      <div class="space-y-1 text-xs text-gray-500">
        @if (popoverEventData.time) {
          <div class="flex items-center">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ popoverEventData.time.toFormat('HH:mm') }}
            @if (popoverEventData.duration) {
              - {{ popoverEventData.time.plus({ minutes: popoverEventData.duration }).toFormat('HH:mm') }}
            }
          </div>
        }
        
        <div class="flex items-center">
          <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
          </svg>
          {{ (popoverEventData.time || popoverEventData.date).toFormat('EEEE, MMMM d, yyyy') }}
        </div>
        
        @if (popoverEventData.project) {
          <div class="flex items-center">
            <div 
              class="w-3 h-3 rounded-full mr-1"
              [style.background-color]="getEventProjectColor(popoverEventData)">
            </div>
            {{ popoverEventData.project }}
          </div>
        }
        
        @if (popoverEventData.duration) {
          <div class="flex items-center">
            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
            {{ popoverEventData.duration }} minutes
          </div>
        }
      </div>
    </div>
  }
</div>
